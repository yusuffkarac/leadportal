generator client {
  provider      = "prisma-client-js"
  output        = "../generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                              String                   @id @default(cuid())
  email                           String                   @unique
  passwordHash                    String
  userTypeId                      String
  createdAt                       DateTime                 @default(now())
  updatedAt                       DateTime                 @updatedAt
  firstName                       String?
  lastName                        String?
  username                        String?                  @unique
  profileImage                    String?
  lastActivity                    DateTime?                // Son aktivite zamanı
  lastIP                          String?                  // Son bağlantı IP adresi
  lastUserAgent                   String?                  // Son kullanılan tarayıcı/cihaz bilgisi
  twoFactorEnabled                Boolean                  @default(false) // 2FA aktif mi?
  twoFactorSecret                 String?                  // 2FA secret key (şifreli)
  isActive                        Boolean                  @default(true) // Kullanıcı aktif mi?
  balance                         Float                    @default(0) // Kullanıcı bakiyesi
  balanceEnabled                  Boolean                  @default(true) // Bakiye özelliği aktif mi?
  paymentMethod                   String                   @default("balance") // "balance" veya "iban"
  ibanAccountHolder               String?                  // IBAN hesap sahibi
  ibanNumber                      String?                  // IBAN numarası (şifreli)
  ibanBic                         String?                  // BIC/SWIFT kodu
  ibanAddress                     String?                  // Adres
  ibanPostalCode                  String?                  // Posta kodu
  ibanCity                        String?                  // Şehir
  approvalStatus                  UserApprovalStatus       @default(PENDING) // Kayıt onay durumu
  registrationRejectionReason     String?                  // Red sebebi (admin notu)
  approvedById                    String?                  // Onaylayan admin
  approvedAt                      DateTime?                // Onay tarihi
  bids                            Bid[]
  leads                           Lead[]                   @relation("LeadOwner")
  purchasedLeads                  LeadSale[]               @relation("LeadBuyer")
  watching                        LeadWatch[]
  userType                        UserType                 @relation(fields: [userTypeId], references: [id])
  leadTypePermissions             UserLeadTypePermission[] @relation("UserLeadTypePermissions")
  approvedBy                      User?                    @relation("ApprovedByAdmin", fields: [approvedById], references: [id])
  approvalsGiven                  User[]                   @relation("ApprovedByAdmin")
  activityLogs                    ActivityLog[]
  passwordResetTokens             PasswordResetToken[]
  balanceTransactions             BalanceTransaction[]
  notifications                   Notification[]
  notificationPreferences         NotificationPreference[]
  feedbacksCreated                Feedback[]              @relation("FeedbackCreator")
  feedbacksAssigned               Feedback[]              @relation("FeedbackAssigned")
  feedbackReplies                 FeedbackReply[]         @relation("FeedbackReplies")
}

model Lead {
  id              String      @id @default(cuid())
  title           String
  description     String
  privateDetails  String?     @db.Text
  postalCode      String?     // Posta kodu (örn. 85309)
  leadType        LeadType    @default(AUCTION) // Lead satış türü
  startPrice      Int
  minIncrement    Int
  instantBuyPrice Int?
  reservePrice    Int?        // Minimum winning price (hidden)
  antiSnipeSeconds Int        @default(120) // Time extension for anti-sniping
  insuranceType   String?     // Sigorta türü
  isActive        Boolean     @default(true)
  isShowcase      Boolean     @default(false)
  isPremium       Boolean     @default(false) // Premium section lead
  isSold          Boolean     @default(false)
  featured        Boolean     @default(false) // Öne çıkan lead
  startsAt        DateTime?   // Açık artırmanın başlangıç zamanı (opsiyonel, boşsa hemen başlar)
  endsAt          DateTime
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  ownerId         String
  bids            Bid[]
  owner           User        @relation("LeadOwner", fields: [ownerId], references: [id])
  sale            LeadSale?
  watchers        LeadWatch[]
}

enum LeadType {
  AUCTION       // Açık artırma
  SOFORT_KAUF   // Anında satın alma
}

enum UserApprovalStatus {
  PENDING       // Onay bekleme durumunda
  APPROVED      // Onaylanmış
  REJECTED      // Reddedilmiş
}

model Bid {
  id        String   @id @default(cuid())
  amount    Int      // Visible current bid amount
  maxBid    Int      // Hidden maximum bid (for proxy bidding)
  isAutoBid Boolean  @default(false) // True if automatically placed by system
  createdAt DateTime @default(now())
  leadId    String
  userId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
}

model LeadWatch {
  id        String   @id @default(cuid())
  leadId    String
  userId    String
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([leadId, userId])
}

enum PaymentStatus {
  PENDING    // IBAN ödemesi bekliyor
  COMPLETED  // Ödeme tamamlandı
  FAILED     // Ödeme başarısız
}

model LeadSale {
  id            String         @id @default(cuid())
  leadId        String         @unique
  buyerId       String
  amount        Int
  paymentMethod String         @default("balance") // "balance" veya "iban"
  paymentStatus PaymentStatus? // Ödeme durumu (IBAN için)
  balanceBefore Int?           // Bakiye ile ödeme yapıldıysa öncesi
  balanceAfter  Int?           // Bakiye ile ödeme yapıldıysa sonrası
  confirmedAt   DateTime?      // Admin ödemeyi onayladığı zaman
  confirmedBy   String?        // Onaylayan admin kullanıcı ID
  adminNotes    String?        // Admin notları
  soldAt        DateTime       @default(now())
  createdAt     DateTime       @default(now())
  buyer         User           @relation("LeadBuyer", fields: [buyerId], references: [id])
  lead          Lead           @relation(fields: [leadId], references: [id])
  feedbacks     Feedback[]
}

model Settings {
  id                  String   @id @default("default")
  leadIdFormat        String   @default("numeric")
  customFormat        String   @default("L{YYYY}{MM}{DD}-{NUM}")
  leadPrefix          String   @default("LEAD")
  startingNumber      Int      @default(1)
  numberType          String   @default("sequential")
  defaultCurrency     String   @default("EUR")
  defaultAuctionDays  Int      @default(7)
  defaultMinIncrement Int      @default(10)
  homepageHeroEyebrow           String   @default("Sigorta lead pazaryeri")
  homepageHeroTitle             String   @default("Almanya'nın önde gelen")
  homepageHeroHighlight         String   @default("sigorta lead")
  homepageHeroTitleSuffix       String   @default("pazaryeri")
  homepageHeroSubtitle          String   @default("LeadPortal, sigorta brokerleri için profesyonel açık artırma altyapısı, doğrulanmış lead kalitesi ve canlı teklif takibi sunar.")
  homepageHeroPrimaryCtaText    String   @default("Şimdi kaydol")
  homepageHeroPrimaryCtaLink    String   @default("/login")
  homepageHeroSecondaryCtaText  String   @default("Canlı açık artırmaları gör")
  homepageHeroSecondaryCtaLink  String   @default("/leads")
  homepageFeatureHeading        String   @default("LeadPortal'ı neden seçmelisiniz?")
  homepageFeatures              Json     @default("[{\"icon\":\"mdi:scale-balance\",\"title\":\"Adil Açık Artırmalar\",\"description\":\"Şeffaf kurallar ve gerçek zamanlı teklifler ile esnek açık artırma modelleri.\"},{\"icon\":\"mdi:shield-check\",\"title\":\"Onaylı Kalite\",\"description\":\"Her lead yayına alınmadan önce kalite ve doğruluk kontrollerinden geçer.\"},{\"icon\":\"mdi:account-group\",\"title\":\"Güvenilir İş Ortağı\",\"description\":\"Broker topluluğumuz için doğrulama süreci ve puanlama sistemi.\"}]")
  homepageShowcaseEyebrow       String   @default("Vitrin leadler")
  homepageShowcaseTitle         String   @default("Aktüel açık artırmalar")
  homepageShowcaseCtaText       String   @default("Hepsini gör")
  homepageShowcaseCtaLink       String   @default("/leads")
  homepageStatsEyebrow          String   @default("Güven veren rakamlar")
  homepageStatsTitle            String   @default("Broker topluluğumuz büyümeye devam ediyor")
  homepageStats                 Json     @default("[{\"value\":\"2.500+\",\"label\":\"Aktif Broker\"},{\"value\":\"15.000+\",\"label\":\"Satılan Lead\"},{\"value\":\"98%\",\"label\":\"Memnuniyet\"},{\"value\":\"€2.1M\",\"label\":\"Toplam Hacim\"}]")
  homepageCtaTitle              String   @default("Başlamak için hazır mısınız?")
  homepageCtaSubtitle           String   @default("LeadPortal topluluğuna katılın, doğrulanmış leadlere erişin ve işinizi güvenle büyütün.")
  homepageCtaPrimaryText        String   @default("Ücretsiz kaydol")
  homepageCtaPrimaryLink        String   @default("/login")
  homepageCtaSecondaryText      String   @default("Leadleri incele")
  homepageCtaSecondaryLink      String   @default("/leads")
  enableBiddingHours  Boolean  @default(false)
  biddingStartHour    String   @default("08:00")
  biddingEndHour      String   @default("20:00")
  maintenanceMode     Boolean  @default(false)
  maintenanceMessage  String   @default("Sistem bakımda. Lütfen daha sonra tekrar deneyin.")
  smtpHost            String   @default("")
  smtpPort            Int      @default(465)
  smtpUser            String   @default("")
  smtpPass            String   @default("")
  smtpFromName        String   @default("LeadPortal")
  smtpUseTLS          Boolean  @default(false)
  smtpUseSSL          Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  companyLogoUrl      String   @default("")
  companyName         String   @default("LeadPortal")
  faviconUrl          String   @default("")
  footerDescription   String   @default("Almanya'nın önde gelen lead pazar yeri. Profesyonel açık artırmalar ve lead yönetimi platformu.")
  footerEmail         String   @default("info@leadportal.com")
  footerNote          String   @default("")
  footerPhone         String   @default("+90 (212) 123 45 67")
  insuranceTypes      Json     @default("[{\"icon\": \"fa-paw\", \"name\": \"Hayvan\"}, {\"icon\": \"fa-car\", \"name\": \"Araba\"}, {\"icon\": \"fa-heart-pulse\", \"name\": \"Sağlık\"}]")
  legalLinks          Json?
  servicesLinks       Json?
  socialMedia         Json?
  supportLinks        Json?
  tradeRegisterNumber String   @default("İstanbul Ticaret Sicil No: 12345")
  sessionTimeoutMinutes Int     @default(120) // Dakika cinsinden oturum timeout süresi (default 2 saat)
  sessionTimeoutMessage String  @default("Oturumunuz hareketsizlik nedeniyle sonlandırılmıştır. Lütfen tekrar giriş yapınız.") // Logout sonrası gösterilecek mesaj
  requireRegistrationApproval Boolean @default(true) // Yeni kayıtlar admin onayı gerektirsin mi?
  registrationApprovalEmail String? // Yeni kayıt bildirimleri için email adresi
  showExpiredLeads Boolean @default(false) // Müşterilere süresi dolmuş/satılmış leadları göster mi?
}

model UserType {
  id                  String               @id
  name                String
  description         String?
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  leadTypePermissions         LeadTypePermission[]         @relation("LeadTypePermissions")
  users                       User[]
  permissions                 UserTypePermission[]
  notificationRolePermissions NotificationRolePermission[]
}

model Page {
  id          String               @id
  name        String
  description String?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  permissions UserTypePermission[]
}

model UserTypePermission {
  id         Int      @id @default(autoincrement())
  userTypeId String
  pageId     String
  hasAccess  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  page       Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  userType   UserType @relation(fields: [userTypeId], references: [id], onDelete: Cascade)

  @@unique([userTypeId, pageId])
}

model LeadTypePermission {
  id         Int      @id @default(autoincrement())
  userTypeId String
  leadType   String
  hasAccess  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userType   UserType @relation("LeadTypePermissions", fields: [userTypeId], references: [id], onDelete: Cascade)

  @@unique([userTypeId, leadType])
}

model UserLeadTypePermission {
  id        Int      @id @default(autoincrement())
  userId    String
  leadType  String
  hasAccess Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("UserLeadTypePermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, leadType])
}

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String
  category  String
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model About {
  id        String   @id @default(cuid())
  section   String
  title     String?
  subtitle  String?
  content   String?
  imageUrl  String?
  data      Json?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DesignSettings {
  id        String   @id @default("default")
  colors    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id          String   @id @default(cuid())
  type        String   @unique
  name        String
  description String?
  subject     String
  htmlContent String
  textContent String?
  isActive    Boolean  @default(true)
  variables   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SMSTemplate {
  id          String   @id @default(cuid())
  type        String   @unique
  name        String
  description String?
  content     String
  isActive    Boolean  @default(true)
  variables   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // LOGIN, LOGOUT, VIEW_LEAD, CREATE_LEAD, EDIT_LEAD, DELETE_LEAD, CREATE_BID, PURCHASE_LEAD, ADD_WATCH, REMOVE_WATCH, VIEW_STATS, CREATE_USER, EDIT_USER, DELETE_USER, CHANGE_SETTINGS, etc.
  details     String?  // JSON string with additional details
  entityType  String?  // "lead", "bid", "user", "settings", etc.
  entityId    String?  // ID of the entity (leadId, bidId, userId, etc.)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model BalanceTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Float    // Pozitif: ekleme, Negatif: düşme
  type        String   // "ADMIN_ADD", "PURCHASE_DEDUCT", "REFUND"
  description String?
  relatedId   String?  // İlgili leadSale veya başka entity ID
  adminId     String?  // İşlemi yapan admin ID (varsa)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

// Bildirim kategorileri
model NotificationType {
  id                   String                         @id @default(cuid())
  code                 String                         @unique // "BID_RECEIVED", "BID_PLACED", "LEAD_SOLD", "LEAD_EXPIRED", "LEAD_CREATED", etc.
  name                 String                         // "Teklif Alındı", "Teklif Verildi", etc.
  description          String?                        // Açıklama
  category             String                         // "BID", "LEAD", "PAYMENT", "ADMIN"
  defaultEnabled       Boolean                        @default(true) // Varsayılan olarak açık mı?
  emailEnabled         Boolean                        @default(true) // Email gönderilebilir mi?
  inAppEnabled         Boolean                        @default(true) // In-app gösterilebilir mi?
  icon                 String?                        // Iconify icon kodu
  isActive             Boolean                        @default(true)
  createdAt            DateTime                       @default(now())
  updatedAt            DateTime                       @updatedAt
  notifications        Notification[]
  userPreferences      NotificationPreference[]
  roleTypePermissions  NotificationRolePermission[]

  @@index([code])
  @@index([category])
}

// Kullanıcıların bildirim tercihleri
model NotificationPreference {
  id                 String             @id @default(cuid())
  userId             String
  notificationTypeId String
  emailEnabled       Boolean            @default(true) // Email almak istiyor mu?
  inAppEnabled       Boolean            @default(true) // In-app bildirim görmek istiyor mu?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationType   NotificationType   @relation(fields: [notificationTypeId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationTypeId])
  @@index([userId])
}

// Bildirimler
model Notification {
  id                 String           @id @default(cuid())
  userId             String
  notificationTypeId String
  title              String
  message            String           @db.Text
  data               Json?            // Ek veriler (leadId, bidId, amount, vb.)
  isRead             Boolean          @default(false)
  readAt             DateTime?
  emailSent          Boolean          @default(false)
  emailSentAt        DateTime?
  createdAt          DateTime         @default(now())
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationType   NotificationType @relation(fields: [notificationTypeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([notificationTypeId])
}

// Rol bazlı bildirim izinleri (admin tarafından yönetilir)
model NotificationRolePermission {
  id                 Int              @id @default(autoincrement())
  userTypeId         String
  notificationTypeId String
  canReceive         Boolean          @default(true) // Bu rol bu bildirimi alabilir mi?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  userType           UserType         @relation(fields: [userTypeId], references: [id], onDelete: Cascade)
  notificationType   NotificationType @relation(fields: [notificationTypeId], references: [id], onDelete: Cascade)

  @@unique([userTypeId, notificationTypeId])
  @@index([userTypeId])
}

// Feedback & Service Desk System
model Feedback {
  id          String            @id @default(cuid())
  leadSaleId  String            @unique // Hangi satın almaya ait geri bildirim (unique - her leadSale'a bir feedback)
  userId      String            // Geri bildirimi gönderen kullanıcı
  subject     String            // Konu (otomatik oluşturulur)
  rating      Int?              // Yıldız puanı (1-5), opsiyonel
  comment     String?           @db.Text // Yorum, opsiyonel
  status      FeedbackStatus    @default(OPEN) // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority    FeedbackPriority  @default(MEDIUM) // LOW, MEDIUM, HIGH, URGENT
  assignedTo  String?           // Hangi admin'e atandı
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  closedAt    DateTime?         // Kapanış zamanı

  // Relations
  user        User              @relation("FeedbackCreator", fields: [userId], references: [id], onDelete: Cascade)
  leadSale    LeadSale          @relation(fields: [leadSaleId], references: [id], onDelete: Cascade)
  assignedToUser User?           @relation("FeedbackAssigned", fields: [assignedTo], references: [id], onDelete: SetNull)
  replies     FeedbackReply[]

  @@index([userId])
  @@index([status])
  @@index([assignedTo])
  @@index([createdAt])
}

// Geri bildirim cevapları (konuşma için)
model FeedbackReply {
  id         String    @id @default(cuid())
  feedbackId String
  userId     String    // Cevap veren kişi (user veya admin)
  message    String    @db.Text
  isAdmin    Boolean   @default(false) // Admin cevabı mı?
  createdAt  DateTime  @default(now())

  // Relations
  feedback   Feedback  @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  user       User      @relation("FeedbackReplies", fields: [userId], references: [id], onDelete: Cascade)

  @@index([feedbackId])
  @@index([userId])
  @@index([createdAt])
}

enum FeedbackStatus {
  OPEN         // Yeni geri bildirim
  IN_PROGRESS  // Admin işleniyor
  RESOLVED     // Çözüldü
  CLOSED       // Kapatıldı
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
